| Markdown版本笔记 | 我的GitHub首页 | 我的博客 | 我的微信 | 我的邮箱 |  
| :------------: | :------------: | :------------: | :------------: | :------------: |  
| [MyAndroidBlogs][Markdown] | [baiqiantao][GitHub] | [baiqiantao][博客] | bqt20094 | baiqiantao@sina.com |  
  
[Markdown]:https://github.com/baiqiantao/MyAndroidBlogs  
[GitHub]:https://github.com/baiqiantao  
[博客]:http://www.cnblogs.com/baiqiantao/  
  
  
***  
目录  
===  

- [基础知识](#基础知识)
	- [消息推送的一些实现方式](#消息推送的一些实现方式)
	- [移动互联网络的现状](#移动互联网络的现状)
	- [移动无线网络的一些特点](#移动无线网络的一些特点)
	- [Android平台上长连接的实现](#Android平台上长连接的实现)
	- [长连接服务器的设计](#长连接服务器的设计)
  
# 基础知识  
[Android：最全面解析Android消息推送解决方案](https://blog.csdn.net/carson_ho/article/details/52693242?locationNum=12)  
  
国内Top500 Android应用中它们用到的第三方推送以及所占数量：  
![](index_files/42018e7c-56f1-4a19-8127-69f2b025698d.jpg)  
  
本质：应用App 主动向用户推送服务器最新消息，实际上，是当服务器有新消息需推送给用户时，先发送给应用App，应用App再发送给用户  
![](index_files/1f23f37c-f125-4543-a868-af5c1772ab39.jpg)  
  
作用  
- 产品角度：功能需要，如：资讯类产品的新闻推送、工具类产品的公告推送等等  
- 运营角度：活动运营需要，如：电商类产品的促销活动；召回用户 / 提高活跃度等等  
  
推送的原理主要是2种方式：Push 和 Pull  
![](index_files/10fc9cae-d098-46ce-9c6a-d98be0d14b9e.jpg)  
  
Android 推送 与 iOS 推送的区别  
![](index_files/e15d6917-2439-4d49-ad47-d90c58e0a836.png)  
  
Android中推送的几种主流方案  
![](index_files/912895cb-599c-4708-ad5e-79a6889524fb.png)  
  
## 消息推送的一些实现方式  
**通过SMS进行服务器端和客户端的交流通信**  
在Android平台上，你可以通过拦截SMS消息并且解析消息内容来了解服务器的意图，可以实现完全的实时操作。但是问题是这个方案的成本相对比较高，且依赖于运营商  
  
**循环主动定时获取**  
这种方法需要客户端来做一个定时或者周期性的访问服务器端接口，以获得最新的消息。轮询的频率太慢可能导致某些消息的延迟，太快则会大量消耗网络带宽和电池  
  
**持久连接**  
这个方案可以解决由轮询带来的性能问题，但是还是会消耗手机的电池。我们需要开一个服务来保持和服务器端的持久连接，苹果和谷歌的C2DM(Cloud to Device Messaging)是这种机制。但是对于Android系统，当系统可用资源较低，系统会强制关闭我们的服务或者是应用，这种情况下连接会强制中断。（Apple的推送服务之所以工作的很好，是因为每一台手机仅仅保持一个与服务器之间的连接，事实上C2DM也是这么工作的，即所有的推送服务都是经由一个代理服务器完成的，这种情况下只需要和一台服务器保持持久连接即可。  
  
相比之下第三种还是最可行的。为软件编写系统服务或开机启动功能；或者如果系统资源较低，服务被关闭后可以在onDestroy ()方法里面再重启该服务，进而实现持久连接的方式。  
  
C2DM内置于Android的2.2系统上，无法兼容老的1.6到2.1系统；且依赖于Google官方提供的C2DM服务器，由于国内的网络环境，这个服务经常不可用。  
  
建立在TCP协议之上的XMPP协议，不仅可提供可这种持久连接的功能，能实现服务器和客户机的双工通信，还能不依赖于系统版本和google服务器的限制，提供了比较好的解决方案。  
  
## 移动互联网络的现状  
因为手机平台本身、电量、网络流量的限制，移动互联网应用在设计上跟传统PC 上的应用很大不一样，需要根据手机本身的特点，尽量的节省电量和流量，同时又要尽可能的保证数据能及时到达客户端。为了解决数据同步的问题，在手机平台上，常用的方法有2种。一种是定时去服务器上查询数据，也叫【Polling轮询】，还有一种手机跟服务器之间维护一个TCP 长连接，当服务器有数据时，实时推送到客户端，也就是我们说的【Push推】。从耗费的电量、流量和数据送达的及时性来说，Push 都会有明显的优势，但Push 的实现和维护成本相对较高。在移动无线网络下维护长连接，相对也有一些技术上的难度。本文试图给大家介绍一下我们极光推送在 Android 平台上是如何维护长连接。  
  
## 移动无线网络的一些特点  
因为 IP v4 的 IP 量有限，运营商分配给手机终端的 IP 是运营商内网的 IP，手机要连接 Internet，就需要通过运营商的网关做一个网络地址转换（Network Address Translation，NAT）。简单的说，运营商的网关需要维护一个外网 IP、端口到内网 IP、端口的对应关系，以确保内网的手机可以跟 Internet 的服务器通讯。  
![](index_files/7a9d036c-a241-4ec4-8160-44eb52d9bca9.jpg)  
NAT 功能由图中的 GGSN 模块实现。  
大部分移动无线网络运营商，都在链路一段时间没有数据通讯时，淘汰 NAT 表中的对应项，造成链路中断。  
  
## Android平台上长连接的实现  
为了不让NAT 表失效，我们需要定时的发心跳，以刷新NAT 表项，避免被淘汰。Android 上定时运行任务常用的方法有2种，一种方法用Timer，另一种是AlarmManager。  
Timer  
Android 的 Timer 类可以用来计划需要循环执行的任务，Timer 的问题是它需要用 WakeLock 让 CPU 保持唤醒状态，这样会大量消耗手机电量，大大减短手机待机时间。这种方式不能满足我们的需求。  
AlarmManager  
AlarmManager 是 Android 系统封装的用于管理 RTC (Real Time Clock) 的模块，RTC是一个独立的硬件时钟，可以在 CPU 休眠时正常运行，在预设的时间到达时，通过中断唤醒 CPU。这意味着，如果我们用 AlarmManager 来定时执行任务，CPU 可以正常的休眠，只有在需要运行任务时醒来一段很短的时间。极光推送的 Android SDK 就是基于这种技术实现的。  
   
## 长连接服务器的设计  
当有大量的手机终端需要与服务器维持长连接时，对服务器的设计会是一个很大的挑战。  
假设一台服务器维护10万个长连接，当有1000万用户量时，需要有多达100台的服务器来维护这些用户的长连接，这里还不算用于做备份的服务器，这将会是一个巨大的成本问题。那就需要我们尽可能提高单台服务器接入用户的量，也就是业界已经讨论很久了的 C10K 问题。  
网络服务在处理数以万计的客户端连接时，往往出现效率底下甚至完全瘫痪，这被成为C10K问题。  
针对这个问题，我们专门成立了一个项目，命名为C2000K，顾名思义，我们的目标是单机维持200万个长连接。最终我们采用了多消息循环、异步非阻塞的模型，在一台双核、24G内存的服务器上，实现峰值维持超过300万个长连接。  
稳定维护长连接是推送平台的一个基础，极光推送团队将会在这方面长期投入，以保证用户能有效的节省电量、流量，同时数据能实时送达。  
  
2019-3-28  
