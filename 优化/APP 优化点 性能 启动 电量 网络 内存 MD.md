| Markdown版本笔记 | 我的GitHub首页 | 我的博客 | 我的微信 | 我的邮箱 |  
| :------------: | :------------: | :------------: | :------------: | :------------: |  
| [MyAndroidBlogs][Markdown] | [baiqiantao][GitHub] | [baiqiantao][博客] | bqt20094 | baiqiantao@sina.com |  
  
[Markdown]:https://github.com/baiqiantao/MyAndroidBlogs  
[GitHub]:https://github.com/baiqiantao  
[博客]:http://www.cnblogs.com/baiqiantao/  
  
APP 优化点 性能 启动 电量 网络 内存  
***  
目录  
===  

- [APP 优化](#APP-优化)
	- [启动时间优化](#启动时间优化)
	- [流量优化](#流量优化)
	- [电量优化](#电量优化)
	- [内存优化](#内存优化)
	- [存储优化](#存储优化)
  
# APP 优化  
  
## 启动时间优化  
整体的思路：  
- 利用提前展示出来的Window显示一个界面，给用户快速反馈的体验；  
- 避免在启动时做密集沉重的初始化；  
- 定位问题：避免I/O操作、反序列化、网络操作、布局嵌套等；  
  
一些可以优化的点：  
- 一些配置获取等网络操作若无需在刚启动时就调用，可以在启动后延后执行；  
- 一些组件、第三方SDK等的初始化操作可以异步执行，或在需要时懒加载；  
- 延迟地图定位、统计分析、日志上传等耗时且可延迟执行的逻辑的执行；  
- 计算耗时、网络、数据库、IO等操作都移到工作线程；  
- 弃用一些大而不当的框架、工具、库、技术方案，选择更高效、专业的；  
- 整合多个类似的框架、工具、库等，例如日志库，图片加载库，json库；  
- 正确使用线程，设置线程的优先级，使用线程池，合理的配置线程池；  
- 去掉仅开发或调试阶段使用，或其他原因现在已无用，或逻辑重复的代码；  
- 对常用设备信息进行缓存，只在第一次使用时获取，之后从缓存中取；  
- 我们项目是多进程的，仅在主进程执行Application的onCreate()相关操作；  
- 利用主题快速显示界面，防止启动白屏和黑屏的问题；  
- 可以考虑使用体验友好的闪屏页，让用户不是在厌恶而是在欣赏中等待；  
  
## 流量优化  
过多以及没有经过处理的网络请求，会消耗用户的网络流量。Android用户一般都会安装手机管理类App，可以方便清楚查看到每个App耗费的流量，高流量消耗会导致经常处于非Wifi场景下的用户卸载。  
  
网络请求耗时会给用户带来卡顿的产品体验，虽然可以使用Loading提升用户体验，但属于治标不治本。  
  
整体的思路：  
- 使用 Android Studio自带的Network Monitor工具，或使用Facebook为Android 开发的Stetho调试工具，或使用Charles、Fiddler等常用的抓包工具，查看并分析某一时间段之内的网络请求数量及访问速率；   
- 监控应用以下三个方面的性能指标：1. 速度；2. 成功率；3. 流量。  
- 无网络状态下直接提示用户无网络，不做网络请求，避免不必要的资源消耗；有网络状态下监控网络状态，将网络分为2G,3G,4G,WIFI,根据不同的网络环境，调整请求策略。以达到最优的请求效率。  
  
  
一些可以优化的点：  
- 使用Gzip压缩：HTTP协议上的Gzip编码是一种用来改进WEB应用程序性能的技术，使用Gzip压缩可以明显减少流量消耗并减少传输的时间。  
- 使用缩略图：App中需要加载的图片根据需要的尺寸加载合适的缩略图即可，只有用户查看大图的时候才去加载原图。不仅节省流量，同时也能节省内存！图片存取时可以在原图链接之后拼接宽高参数，根据参数的不同返回相应的图片。  
- 使用WebP格式；同样的照片，采用WebP格式可大幅节省流量，相对于JPG格式的图片，流量能节省将近 25% 到 35 %；相对于 PNG 格式的图片，流量可以节省将近80%。最重要的是使用WebP之后图片质量也没有改变。  
- 使用断点续传：文件、图片等的下载，采用断点续传，不浪费用户之前消耗过的流量。  
- 使用重试策略：一次网络请求的失败，需要多次的重试来断定最终的失败。  
- 避免客户端的轮询：如有需要，应采用服务器推送的方式。  
- 数据更新采用增量而不是全量：仅将变化的数据返回，客户端进行合并。  
- 使用最新的Http协议：Http协议有多个版本(0.9、1.0、1.1、2)，新的版本不仅可以节省资源，同样可以减少流量。  
- 打包合并网络请求：例如统计类型的接口，无需实时上报，将统计信息保存在本地，然后根据策略统一上传。这样头信息仅需上传一次，减少了流量也节省了资源。  
- 使用网络缓存：对服务端返回数据进行缓存，设定有效时间，有效时间之内不走网络请求，减少流量消耗。  
- 使用 Protocol Buffer：PB是Google的一种数据交换的格式，它独立于语言，独立于平台，相较于目前常用的Json，数据量更小，解析更快。  
- 根据网络状态对网络请求进行区别对待：例如，在Wifi场景下可以进行数据的预取、一些统计的集中上传等；而在2G场景下此类操作以及网络请求的次数策略都应该调低。  
- 使用IP直连代替DNS解析：DNS解析的失败率占联网失败中很大一部分，而且首次域名解析一般需要几百毫秒。针对此，我们可以不用域名而用IP直连省去 DNS 解析过程。  
- 使用 HttpDns：HttpDNS是基于Http协议的域名解析，替代了基于DNS协议向运营商Local DNS发起解析请求的传统方式，可以避免Local DNS造成的域名劫持和跨网访问问题，解决域名解析异常带来的困扰。  
- 采用分片上传图片：图片的上传失败率比较高，不仅仅因为文件大，同时带宽、时延、稳定性等因素在此场景下的影响也更加明显；避免整文件传输，采用分片传输；根据网络类型以及传输过程中的变化动态的修改分片大小；每个分片失败重传的机会。  
- 利用时间戳拉取数据；按需拉取、延迟拉取。  
  
## 电量优化  
对于用户来说, App的电量损耗是用户体验的一个重要方面。 特别是当今人们对移动设备的依赖度越来越高, 电量也是用户特别关注的。  
  
整体的思路：  
- Android4.1版本之后在系统增加了battery info模块，可以获取一定时间周期内整机及单个App的电量消耗。  
- Android5.0之后Google开源了一款用于检测与电池有关的信息和事件的工具 Battery Historian，可以从设备中收集电池数据，然后可视化分析相关指标，如耗电比例、Wifi、蜂窝数据量、WakeLock唤醒次数。  
- Android6.0更新了Battery Historian 2.0,加入引起手机状态变化的应用。  
  
通过Battery Historian可以方便的看到各耗电模块随着时间的耗电情况：包含操作类型、执行时间、对应App等；还可以进行筛选特定的App，给出一个总结性的说明，包括：Network Information、 Syncs、WakeLock、Services、Process info、Scheduled Job、Sensor Use等，查看每一个模块的总结，可以看出来每一项的耗时以及执行次数。当发现异常的时候可以针对性的进行排查。  
  
Android系统上App的电量消耗主要由cpu、wakelock、数据传输、wifi运行、gps、senior组成，而耗电异常也是由于这几个模块的使用不当。  
  
一些可以优化的点：  
- UI优化：控件不可见时不更新；控件滑动时不更新，只更新列表特定的item，甚至只更新item的特定部位；控件更新设置一定的间隔。  
- 动画优化：及时停止动画，特别是动画不可见时；按需开启硬件加速；慎重使用帧动画；慎重永久循环播放动画。  
- 图片优化：加载大图时要裁剪、压缩；加载图片时选择合适的颜色模式。  
- 定位优化：定位精度按需调整，对于定位精度要求不高的地方，降低定位精度；缩短定为时间，不需要位置信息之后及时注销定位监听；多模块使用定位尽量复用；选择合适的Location Provider(GPS、NETWORK、PASSIVE等)。  
- 网络优化：详见2.1.2中的优化点。  
- CPU时间片优化：当检测到CPU时间片消耗异常时，可以使用TraceView获取进程执行信息，定位CPU占用率异常的问题。  
- 定时器优化：及时关闭不需要掉定时器，合理设置定时器的周期，设置一个合适的超时时间。  
- 谨慎使用WakeLock：App在前台不要申请WakeLock；App在后台由于业务需要必须要申请WakeLock时使用带有超时参数的方法，防止由于忘记或者异常情况下没有释放；App申请使用WakeLock，任务结束之后及时释放，让系统再次进入休眠状态。  
- 使用JobScheduler：一些任务可以通过JobScheduler来触发，例如可推迟的网络请求、下载、GPS等，可以在如连接Wifi、连接电源等场景时触发。  
- 传感器使用优化：使用传感器时要选择合适的采样率，越高的采样率类型则越费电；•在后台时注意及时注销传感器监听。  
  
## 内存优化  
如果一个无用对象（不需要再使用的对象）仍然被其他对象持有引用，造成该对象无法被系统回收，以致该对象在堆中所占用的内存单元无法被释放而造成内存空间浪费，这中情况就是内存泄露。  
  
在Android开发中常见的内存泄露场景如下，内存优化的很重要一点就是解决以下情况导致的内存泄露问题：  
- 单例导致内存泄露  
- 静态变量导致内存泄露  
- 非静态内部类导致内存泄露  
- 未取消注册或回调导致内存泄露  
- Timer和TimerTask导致内存泄露  
- 集合中的对象未清理造成内存泄露  
- 资源未关闭或释放导致内存泄露  
- 动画造成内存泄露  
- WebView造成内存泄露  
- 静态集合类造成内存泄露  
  
其他的一些内存优化点：  
- 常用数据结构优化，ArrayMap及SparseArray是android专门为移动设备而定制的集合类，用于在一定情况下取代HashMap而达到节省内存的目的,对于key为int的HashMap尽量使用SparceArray替代，大概可以省30%的内存。  
- 枚举，Android平台上枚举是比较争议的，在较早的Android版本，使用枚举会导致包过大，而目前Android官方建议，使用枚举变量还是需要谨慎，因为枚举变量可能比直接用int多使用2倍的内存。  
- ListView复用，这个大家都知道，getView里尽量复用conertView,同时因为getView会频繁调用，要避免频繁地生成对象  
- 谨慎使用多进程，现在很多App都不是单进程，为了保活，或者提高稳定性都会进行一些进程拆分，而实际上即使是空进程也会占用内存(1M左右)，对于使用完的进程，服务都要及时进行回收。  
- 尽量使用系统资源，系统组件，图片甚至控件的id  
- 减少view的层级，对于可以 延迟初始化的页面，使用viewstub  
- 数据相关：序列化数据使用protobuf可以比xml省30%内存，慎用shareprefercnce，因为对于同一个sp，会将整个xml文件载入内存，有时候为了读一个配置，就会将几百k的数据读进内存，数据库字段尽量精简，只读取所需字段。  
- dex优化，代码优化，谨慎使用外部库，不仅占用rom空间，实际上运行的时候需要加载dex也是会占用内存的(几M)，有时候为了使用一些库里的某个功能函数就引入了整个庞大的库，此时可以考虑抽取必要部分，开启proguard优化代码，使用Facebook redex优化dex。  
  
## 存储优化  
每一个Android应用基本都避免不了在用户设备上读写数据，特别是一些缓存文件，持久化存储数据，日志文件，图片文件，H5资源文件等。文件管理不当很可能会让用户感觉到APP过分占用存储空间，或者存储目录混乱，进而导致用户反感甚至卸载。  
  
存储优化主要可以在以下几个方面进行：  
在合适的时机以合适的方式向用户申请文件读写权限；  
统一管理存储目录，防止出现在用户手机四处存放文件的现象，严禁出现在用户SD卡根目录直接存放文件的行为；  
如果是临时文件，使用完毕后要及时删除，以避免大量占用用户存储空间；  
避免出现多次重复存储同一文件的行为，特别是需要联网下载的文件；  
在APP中提供用户”清除缓存”的功能，具体可以清理的文件由我们确定，以防止用户通过系统设置把全部缓存清理掉；  
缓存文件应设置阈值，超过阈值后应主动触发清理缓存文件的逻辑，具体清理规则由我们确定；  
根据不同的场景，由我们决定将文件存储在APP私有目录中还是用户及其他APP均可操作的公共目录中；  
建议采用MD5加密后的值作为文件名，既防止文件名不合法(包含特殊字符、长度超过限制等)隐患，又可以防止被用户或其他APP随意读取。  
  
2018-12-31  
